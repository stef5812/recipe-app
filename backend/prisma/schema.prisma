generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recipe_feedback {
  id         BigInt   @id @default(autoincrement())
  recipe_id  BigInt
  user_id    BigInt
  rating     Int
  comment    String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  recipes    recipes  @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([recipe_id, user_id], map: "uq_feedback_one_per_user")
  @@index([recipe_id], map: "idx_feedback_recipe_id")
  @@index([user_id], map: "idx_feedback_user_id")
}

model recipe_ingredients {
  id              BigInt   @id @default(autoincrement())
  recipe_id       BigInt
  ingredient_name String   @db.VarChar(120)
  amount          Decimal? @db.Decimal(10, 2)
  unit            String?  @db.VarChar(20)
  note            String?  @db.VarChar(255)
  sort_order      Int      @default(1)
  stage_number    Int      @default(1)
  stage_name      String?  @db.VarChar(80)  
  recipes         recipes  @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([recipe_id], map: "idx_ingredients_recipe_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recipe_media {
  id         BigInt   @id @default(autoincrement())
  recipe_id  BigInt
  media_type String   @db.VarChar(10)
  url        String
  caption    String?  @db.VarChar(255)
  is_primary Boolean  @default(false)
  sort_order Int      @default(1)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  recipes    recipes  @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([recipe_id, is_primary], map: "idx_recipe_media_primary")
  @@index([recipe_id], map: "idx_recipe_media_recipe_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recipe_step_media {
  id           BigInt       @id @default(autoincrement())
  step_id      BigInt
  media_type   String       @db.VarChar(10)
  url          String
  caption      String?      @db.VarChar(255)
  sort_order   Int          @default(1)
  created_at   DateTime     @default(now()) @db.Timestamptz(6)
  recipe_steps recipe_steps @relation(fields: [step_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([step_id], map: "idx_step_media_step_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recipe_steps {
  id                BigInt              @id @default(autoincrement())
  recipe_id         BigInt
  step_number       Int
  instruction       String
  recipe_step_media recipe_step_media[]
  recipes           recipes             @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([recipe_id, step_number], map: "uq_recipe_step")
  @@index([recipe_id], map: "idx_steps_recipe_id")
}

enum recipe_category {
  ENTREE
  SOUP
  STARTER
  MAIN
  DESSERT
  CAKE
  SWEET
}

model recipes {
  id                 BigInt               @id @default(autoincrement())
  user_id            BigInt
  source             String?              @db.VarChar(255)
  name               String               @db.VarChar(120)
  description        String?
  country            String               @default("Not known") @db.VarChar(80)
  category           recipe_category?     // optional (or make required if you prefer)
  created_at         DateTime             @default(now()) @db.Timestamptz(6)
  updated_at         DateTime             @default(now()) @db.Timestamptz(6)
  recipe_feedback    recipe_feedback[]
  recipe_ingredients recipe_ingredients[]
  recipe_media       recipe_media[]
  recipe_steps       recipe_steps[]
  users              users                @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_recipes_user_id")
}

model users {
  id              BigInt            @id @default(autoincrement())
  username        String            @unique @db.VarChar(50)
  password_hash   String
  is_admin        Boolean           @default(false)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  recipe_feedback recipe_feedback[]
  recipes         recipes[]
}

